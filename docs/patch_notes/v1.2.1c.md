# Patch Notes — v1.2.1c

## Summary
- Normalise FITS time-axis offsets during ingestion so time samples are emitted in the canonical frame before provenance capture. 【F:app/server/ingest_fits.py†L519-L550】【F:app/server/ingest_fits.py†L1475-L1527】
- Block time-series payloads from overlay ingestion with clear user messaging and filter any residual time traces out of overlay rendering. 【F:app/ui/main.py†L970-L1050】【F:app/ui/main.py†L373-L382】【F:app/ui/main.py†L1885-L1934】【F:app/utils/local_ingest.py†L461-L482】
- Add regression coverage with TESS-like headers for FITS ingestion, overlay rejection, and rendering safeguards to document the new policy. 【F:tests/server/test_ingest_fits.py†L435-L513】【F:tests/server/test_local_ingest.py†L517-L691】【F:tests/ui/test_overlay_time_policy.py†L15-L65】

## Details
1. **Time-axis normalisation**
   - Subtract detected FITS time offsets inside `_extract_table_data` and mark the provenance so downstream code works with offset-free quantities. 【F:app/server/ingest_fits.py†L519-L550】
   - Guard the parse layer against double subtraction by honouring the new `offset_subtracted` flag when building metadata. 【F:app/server/ingest_fits.py†L1475-L1527】
2. **Overlay policy enforcement**
   - Reject time-series overlays in both `_add_overlay` and local ingest, surface the policy in error messages, and exclude time traces from overlay figures, grouping, and reference selection. 【F:app/ui/main.py†L970-L1050】【F:app/ui/main.py†L1885-L1934】【F:app/utils/local_ingest.py†L461-L482】
   - Extend session utilities to treat time traces like images when deduplicating references and similarity sources. 【F:app/ui/main.py†L2726-L3200】
3. **Regression coverage**
   - Add targeted server and UI tests that construct TESS-like light-curve HDUs to assert FITS offsets are normalised, local ingest blocks time-series payloads, and overlay rendering ignores stray time traces. 【F:tests/server/test_ingest_fits.py†L435-L513】【F:tests/server/test_local_ingest.py†L517-L691】【F:tests/ui/test_overlay_time_policy.py†L15-L65】
   - Update existing FITS ingestion tests to confirm the new provenance metadata. 【F:tests/server/test_ingest_fits.py†L491-L513】

## Verification
- `pytest tests/server/test_ingest_fits.py tests/server/test_local_ingest.py tests/ui/test_overlay_time_policy.py -q` 【3af223†L1-L37】

## Continuity
- Bumped `app/version.json` to v1.2.1c with the updated summary. 【F:app/version.json†L1-L4】
- Logged the change in `docs/atlas/brains.md` and recorded the AI activity entry for 2025-10-20. 【F:docs/atlas/brains.md†L1-L6】【F:docs/ai_log/2025-10-20.md†L1-L33】
