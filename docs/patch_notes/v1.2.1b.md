# Patch Notes — v1.2.1b

## Summary
- Skip image overlays when building differential similarity vectors and guard reference vectorisation so image traces never trigger ValueError in similarity workflows. 【F:app/ui/main.py†L3174-L3184】【F:app/ui/main.py†L1893-L1899】
- Add a differential tab regression that loads an image overlay to ensure the panel renders without raising exceptions. 【F:tests/ui/test_differential_form.py†L137-L151】

## Details
1. **Vectorisation guardrails**
   - Filter similarity sources to exclude image overlays and keep the fallback set image-free so the similarity pipeline only vectorises spectral/time traces. 【F:app/ui/main.py†L3174-L3184】
   - Skip building reference vectors when the selected reference overlay is an image, preventing accidental calls to `to_vectors` on image payloads. 【F:app/ui/main.py†L1893-L1899】
2. **Regression coverage**
   - Added an AppTest that mixes spectral and image overlays, runs the differential tab, and asserts no exception surfaces, covering the previous ValueError scenario. 【F:tests/ui/test_differential_form.py†L137-L151】

## Verification
- `pytest tests/ui/test_differential_form.py -q` 【6cbe60†L1-L2】

## Continuity
- Bumped `app/version.json` to v1.2.1b with the new summary. 【F:app/version.json†L2-L5】
- Logged the change in `docs/atlas/brains.md` and recorded the AI activity entry for 2025-10-20. 【F:docs/atlas/brains.md†L1-L8】【F:docs/ai_log/2025-10-20.md†L1-L16】
