# Brains — v1.1.4
_Last updated (UTC): 2025-09-19T23:40:43Z_

## Purpose
This document preserves the working mental model for **Spectra App v1.1.4**. It records what must never break, what we are adding, why we are adding it, and how to verify everything still works. Treat this as continuity-of-operations for future patches.

## Canonical Continuity Sources
- `docs/brains/v1.1.4 brains.md` (this file)
- `docs/ai_handoff/AI_HANDOFF_PROMPT_v1.1.4.md` (next-handoff instructions)
- `docs/ui_contract.json` (UI invariants; see v1.1.4 deltas below)
- `docs/patches/PATCH_NOTES_v1.1.4.md` (diffs and known issues)
- `app/version.json` must read `"v1.1.4"` and propagate into exports

## Non‑Breakable Invariants (carryover from v1.1.3g, reaffirmed for v1.1.4)
1. **Overlay** works with examples and uploads; legend has no empties; “export what I see” bundles PNG + CSV subset + JSON manifest.
2. **Differential** supports A − B, A / B with resampling + normalization; A = B returns a near-zero line and must not crash.
3. **Unit toggles** are idempotent: nm ↔ Å ↔ µm ↔ cm⁻¹ round‑trip without cumulative error. Always re-derive from a canonical nm baseline.
4. **Duplicate guard** respects Global / Session / Off scopes with override and purge. Labels don’t multiply unless user “ingests anyway.”
5. **Provenance**: exports contain source, date fetched, transformations, units resolved, and app version. Round‑trips are visible in logs.

## Current State Summary (pre‑v1.1.4)
- Overlay: stable with large datasets; dedupe banners present; example toggles OK.
- Differential: correct numerics; UX issues remain (dropdown resets, trace clutter, trivial-result legend duplication, division spikes when B ≈ 0).
- Unit Conversions: correct, round‑trip observed on large files.
- Export: bundles PNG/CSV/manifest with lineage and units.

## v1.1.4 Scope
**Goal:** Add modular **data fetching** and apply targeted **Differential UX fixes** without changing existing Overlay math or app structure.
- New fetchers for archives (initial set): SIMBAD resolver, MAST spectra, ESO minimal.
- Normalize fetched data to canonical nm baseline with full provenance (DOI, URL, instrument, target, obsid/program, citation text).
- Treat fetched spectra like uploads: appear in Overlay, eligible for Differential, governed by dedupe ledger.
- UX fixes: persistent A/B selections, grouped trace dropdowns, epsilon‑guarded division, zero‑result suppression toggle.
- Update UI contract, patch notes, checksums and Brains/AI handoff to **v1.1.4**.

## Architecture Decisions (v1.1.4)
- **Fetcher package:** `app/server/fetchers/` with `mast.py`, `simbad.py`, `eso.py` behind a thin router `fetch_archives.py`.
- **Data model:** single `NormalizedSpectrum` dataclass (see below) for uploads and fetched data.
- **Canonical baseline:** store wavelengths in **nm**; UI conversions always re-derive views from this baseline.
- **Provenance unification:** all sources emit a `provenance` block merged into export manifests. Hash raw payloads (SHA‑256).
- **Non‑invasive UI:** add “Fetch Data” section/tab. No rewrites. Independent keys for Differential A/B.
- **Safety:** division guard via epsilon and optional masking; trivial results suppressed by default with “Add anyway.”

## Data Model
```text
NormalizedSpectrum:
  wavelength_nm: float[]
  intensity: float[]
  meta:
    source_type: "upload" | "fetch"
    archive: "MAST" | "ESO" | "SIMBAD" | "LOCAL"
    target_name: string
    instrument: string
    obs_id: string | null
    program_id: string | null
    doi: string | null
    access_url: string | null
    citation_text: string | null
    fetched_at_utc: ISO-8601 | null
    file_hash_sha256: hex | null
    units_original: string  # e.g., 'Angstrom', 'nm', 'micron'
    app_version: "v1.1.4"
```

## Provenance Fields (per trace)
- `archive`, `target_name`, `instrument`, `obs_id`/`program_id`
- `doi`, `access_url`, `citation_text`
- `fetched_at_utc` (for fetched data)
- `file_hash_sha256` of the on-disk artifact
- `units_original` and `units_display`
- `transforms`: unit conversions, resampling, normalization
- `app_version: v1.1.4`

## Export Manifest — Schema Delta (v1.1.4)
Add fields under each trace:
```json
{
  "trace_id": "mast:stis:...",
  "source_type": "fetch",
  "fetch_provenance": {
    "archive": "MAST",
    "target_name": "Betelgeuse",
    "instrument": "STIS",
    "obs_id": "O1XYZ",
    "program_id": "P12345",
    "doi": "10.17909/T9-abc123",
    "access_url": "https://...",
    "citation_text": "Author Year, Journal, DOI",
    "fetched_at_utc": "2025-09-19T23:40:43Z",
    "file_hash_sha256": "…"
  },
  "units": {
    "baseline": "nm",
    "display": "nm"
  },
  "math_lineage": {
    "op": "A/B",
    "operands": ["trace_A", "trace_B"],
    "epsilon": 1e-9,
    "resample": "linear|spline",
    "normalization": "none|max"
  },
  "app_version": "v1.1.4"
}
```

## UI Changes (v1.1.4)
- New “Fetch Data” section with Archive/Target/Instrument/ObsID fields and “Fetch → Normalize → Add” button.
- Dedup option: “Skip if duplicate” (default ON).
- Differential:
  - Keys: `trace_a`, `trace_b` are independent and persistent.
  - Grouped dropdown: “Original inputs” and “Derived traces.”
  - Controls: `Enable division guard` (epsilon default 1e-9), `Mask near-zero B` toggle.
  - Trivial zero result: suppressed with snackbar and “Add anyway.”

## Algorithms & Numerics
- **Unit conversions:** nm ↔ Å ↔ µm ↔ cm⁻¹ must round‑trip by re‑deriving from canonical nm arrays.
- **Division guard:** compute `A/(B + ε)` with configurable `ε`; when `|B| < τ`, optionally mask rather than inflate spikes; record `ε` and mask policy in `math_lineage`.
- **Resampling:** keep linear by default; avoid re-smoothing unless user selects it. Provenance must log method and parameters.

## Duplicate Ledger Behavior
- Global and Session scopes persist; “Off” bypasses checks. Re‑uploads do not change labels unless user chooses “ingest anyway.”
- Fetched traces also register in the ledger via computed hash and archive identifiers.

## Verification Checklist (smoke + contract)
1. Unit toggles: nm → Å → µm → cm⁻¹ → nm equals original within tolerance.
2. Overlay: multiple inputs render; legend has no empties or duplicate labels.
3. Duplicate guard: re‑ingesting same file yields banner; no double plotting.
4. Differential:
   - A and B selections persist through list changes.
   - A − A suppressed by default; can be added explicitly.
   - A/B with near‑zero B respects epsilon; masked regions are visible but not spiky.
5. Fetch tab:
   - Fetch a known target; trace appears in Overlay with “fetched” metadata.
   - Export manifest contains full fetch_provenance.
6. UI contract: `scripts/verify_ui_contract.py` passes new invariants.

## Runbook (Windows)
```
C:\\Code\\spectra-app\\RUN_CMDS\\Verify-Project.ps1
C:\\Code\\spectra-app\\RUN_CMDS\\Verify-UI-Contract.ps1
C:\\Code\\spectra-app\\RUN_CMDS\\Start-Spectra-Patched.ps1
```
Optional smoke:
```
python C:\\Code\\spectra-app\\scripts\\fetch_samples.py
```

## Risks & Mitigations
- Archive schema drift → pin astroquery where reasonable; centralize parsing; fail soft with actionable messages.
- Provenance size → keep citation text concise; always include DOI and URL.
- User spam‑click on Fetch → disable button while in flight; dedupe first.

## Backlog (post‑v1.1.4)
- Extend ESO loader coverage; add JWST NIRSpec/MIRI HLSP convenience.
- Add modeling overlays (PHOENIX/Cloudy/PSG) as separate trace types with explicit provenance.
- Session vs global dedupe toggle in UI and clearer user messaging.
- Rename/alias derived traces; grouped legend folding for readability.

## Coding Standards (extract)
- UTF‑8, no ellipses, no placeholder code. Docstrings include version + brief rationale.
- Public functions have type hints and raise project errors with user‑safe messages.
- Tests/verifiers accompany every UI‑visible change.

## File Tree Deltas (intended)
```
app/server/fetchers/[simbad.py, mast.py, eso.py]
app/server/fetch_archives.py
app/server/models.py
app/server/provenance.py
docs/brains/v1.1.4 brains.md
docs/ai_handoff/AI_HANDOFF_PROMPT_v1.1.4.md
docs/patches/PATCH_NOTES_v1.1.4.md
```
(Only the Brains file is included in this artifact; the rest are implemented by the patch.)

## Changelog (v1.1.4)
- Added: modular data fetchers (design + contract), fetch provenance fields, Differential UX fixes plan.
- Updated: UI contract and verification checklist.
- Verified: invariants from v1.1.3g remain non‑negotiable.
- Version self‑reference: **v1.1.4** everywhere.
