# Spectra App — Engineering Brains (v1.1.3d context)
_Last updated (UTC): 2025-09-19T22:23:22.106428_

This file preserves everything we’ve learned: what works, what fails, mistakes made, and how we corrected them.  
It must always travel with the repo so future maintainers don’t repeat the same errors.

---

## 0) Project Snapshot
- **Patch line:** v1.1.3x (screenshots up to v1.1.3d)
- **Next target:** v1.1.3e → canonical unit fix
- **Entrypoint:** `app/app_merged.py`
- **UI verification:** `docs/ui_contract.json` + `Verify-UI-Contract.ps1`

---

## 1) UI Contract (Non‑negotiables)
These must never disappear:
- Sidebar with **Examples**, **Display mode**, **Display units**, **Export what I see**
- Tabs/modes: Overlay, Differential, Docs
- **Version badge** with `version.json` data (top‑right)
- “What’s new in this patch?” expander
- Legend hygiene (no empty labels)

Reason: earlier patches amputated these when reworking entrypoints.  
Fix: contract + static verifier script.

---

## 2) Currently Working
- Overlay: multiple traces (examples + uploads) render with correct legend labels.
- Differential: A/B selectors, A−B / A/B ops, normalization, resample slider, compute button.
- Examples: He + Ne seeded so plots are never blank at start.
- Duplicate guard: SHA‑256 digest blocks identical re‑uploads (persists across refresh).
- Export: produces CSV + manifest JSON with app version, unit, provenance slots.
- Unit toggle (basic): switching nm ↔ Å ↔ µm ↔ cm⁻¹ changes labels and rescales traces.
- Traceback visible on ingest failure (so problems aren’t silent).

---

## 3) Broken or Misleading
### 3.1 Unit Toggling
- **Problem:** conversions happen on already‑converted arrays. After nm→Å→µm→cm⁻¹→nm, values are wrong. Axis stays stuck at ~0–10k.  
- **Fix:** store canonical nm array for each trace; regenerate view arrays fresh each toggle.

### 3.2 CSV Ingest
- **Problem:** metadata lines like “Date: Tue Sep 09 …” crash parsing.  
- **Fix:** add row‑skip / header detection, fallback delimiter sniffing, provenance log of skipped rows.

### 3.3 Duplicate Guard UX
- **Problem:** After refresh, one upload flagged as “duplicate skipped.”  
- **Cause:** ledger persists globally.  
- **Fix:** add scope toggle (Session | Global | Off), override button, show first‑seen timestamp + size, cache manager.

### 3.4 Missing Version Badge
- **Problem:** Badge missing in several 1.1.3x builds.  
- **Fix:** reinstate badge tied to version.json.

### 3.5 Docs Tab Stub
- **Problem:** says “Docs panel placeholder.”  
- **Fix:** populate with quick‑start, format expectations, provenance policy.

---

## 4) Mistakes + Corrections
- **Replaced UI instead of merging.** Fixed with merged entry + contract verifier.  
- **In‑place unit scaling.** Fix planned: canonical nm baseline.  
- **Fragile CSV parsing.** Fix planned: metadata skip + provenance logging.  
- **Over‑strict dedupe.** Fix planned: scope toggle + override.  
- **Hidden provenance logs.** Fix planned: on‑screen collapsible drawer.

---

## 5) Rules of Engagement
**Do**
- Ship patch‑only increments with version.json, patch notes, checksums.  
- Keep seeded examples visible.  
- Enforce legend hygiene.  
- Record export manifest with provenance + unit logs.  
- Run UI contract verifier every patch.

**Don’t**
- Don’t amputate UI pieces without updating contract.  
- Don’t mutate canonical data on unit toggles.  
- Don’t silently fail ingest.  
- Don’t force manual file edits.

---

## 6) Planned Patch Sequence
- **v1.1.3e:** canonical unit pipeline; idempotent conversions.  
- **v1.1.3f:** dedupe UX (scope, override, cache mgmt).  
- **v1.1.3g:** reinstate version badge + provenance drawer.  
- **v1.1.4:** consolidated release (merged UI + guardrails).

---

## 7) Verification Checklist
1. Run `Verify-UI-Contract.ps1` → pass.  
2. Smoke run app. Confirm: examples visible, sidebar intact, version badge, patch notes expander.  
3. Overlay: upload CSV/TXT with headers + metadata → no crash. Legend has no empty labels.  
4. Unit toggle cycle nm→Å→µm→cm⁻¹→nm → axis values remain correct.  
5. Differential: compute A−B and A/B with overlap → derived trace appears.  
6. Dedupe: same file twice = flagged; refresh+upload once = allowed (session scope).  
7. Export: CSV subset + manifest JSON with version, units, provenance.

---

## 8) Key Paths
- Entrypoint: `app/app_merged.py`  
- Version file: `app/version.json`  
- UI contract: `docs/ui_contract.json`  
- Verifier: `scripts/verify_ui_contract.py`  
- Dedupe ledger: `.cache/ledger.json`  
- Exports: `exports/*.csv` + `*.manifest.json`

---

## 9) Provenance Expectations
Manifest should log:  
- Data source (file/doi/url/instrument)  
- Ingest timestamp (UTC)  
- Transformations (unit conversions, skips, normalization)  
- Duplicate lineage (`duplicate_of` if override)  
- Derived traces with `parents[]` and `ops[]`

---

## 10) Open Questions
- Should cm⁻¹ be offered as secondary axis instead of toggle?  
- Add fetchers for MAST, SIMBAD, ESO, IACOB.  
- Export PNG consistently with CSV/manifest.  

---

### TL;DR
- Merge, never amputate UI.  
- Unit toggles idempotent from canonical nm.  
- CSV ingest must skip metadata gracefully.  
- Dedupe should be session‑aware with overrides.  
- Provenance must be visible, not just exported.
