# Implementation Playbook — Integrating Code into an Existing Framework (v1.1.4a)

**Purpose:** Practical guidance to add/modify functionality in the Spectra App without breaking wiring, imports, or UI. This codifies lessons learned in v1.1.3e → v1.1.4a.

**Scope:** Streamlit UI (`app/ui/*`), entry modules (`app/app_patched.py`), server-side logic (`app/server/*`, `app/logic/*`), utilities (`app/utils/*`), docs (`docs/*`), examples (`examples/*`).

---

## 1. Core Principles

1. **Single source of truth for entry:** Always launch via `app/app_patched.py`. That file must not contain ad‑hoc UI; it should delegate to `app.ui.main` (or the current UI entry) and be safe to import repeatedly.
2. **Idempotent patches:** Patches must be re‑runnable without duplicating files, functions, or UI. Scripts should check before writing or appending.
3. **No nested trees:** Never unzip a patch into the project root if the top-level folder matches the root name (e.g., avoid `spectra-app/spectra-app`). Flatten first.
4. **Version and provenance must match reality:** `app/version.json` is the visible truth. Every export includes a manifest of versions, sources, and transformations.
5. **UI contract first:** Maintain a stable set of controls and tabs. Any change to controls must update the UI contract and the verifier.
6. **Guard the UI:** Interactive handlers (examples, file reads, plot updates) must be wrapped so exceptions render as errors, not blank screens.
7. **Reproducibility over cleverness:** Provide exact commands, patch notes, and a manifest of changes.

---

## 2. Pre‑Flight Checklist (Before Applying Any Patch)

- [ ] Back up the working tree (zip the root and, if present, any nested folder by mistake).
- [ ] Verify you are in the **real** root: `C:\Code\spectra-app`.
- [ ] Confirm the entry file resolves to the correct module:
  ```powershell
  $py = 'C:\Code\spectra-app\.venv\Scripts\python.exe'; if (!(Test-Path $py)) { $py='python' }
  & $py -c "import importlib,inspect; m=importlib.import_module('app.app_patched'); print(inspect.getfile(m))"
  ```
  Expected: `C:\Code\spectra-app\app\app_patched.py`.
- [ ] Read `app/version.json` and ensure intended target (e.g., `v1.1.4x`).

---

## 3. Patch Packaging Rules

- **Structure:** Patch zips must root at `spectra-app/…` so unzip targets the project root.
- **RUN_CMDS:** Include PowerShell scripts for apply/verify/rollback under `spectra-app/RUN_CMDS/`.
- **Never overwrite silently:** For in‑place edits, prefer scripts that *search and replace* known markers or write new files; keep a `.bak` backup when overwriting a single file.
- **Ship only patch versions:** v0.2.x → v0.2.9x, v1.1.4a → v1.1.4x with detailed notes.

---

## 4. Safe Apply Procedure

1. **Stop the app** (free file locks).
2. **Unzip patch to `C:\Code\`** (not inside the app folder) so files land under `C:\Code\spectra-app\…`.
3. **Run patch scripts:**
   - Apply patch (file writes, markers, migrations).
   - Update `version.json` (if patch bumps version).
4. **Purge bytecode** so Python reloads fresh:
   ```powershell
   Get-ChildItem -Path 'C:\Code\spectra-app' -Recurse -Directory -Filter '__pycache__' | Remove-Item -Recurse -Force
   ```
5. **Verify:** `RUN_CMDS/Verify-Project.ps1` and `RUN_CMDS/Verify-UI-Contract.ps1`.
6. **Start:** `RUN_CMDS/Start-Spectra-Patched.ps1`.

---

## 5. Wiring & Imports (Entrypoint, Shims, Reload)

- **Entrypoint:** `app/app_patched.py` should *only* import the full UI and optionally reload it each run:
  ```python
  import importlib, streamlit as st
  try:
      m = importlib.import_module('app.ui.main'); importlib.reload(m)
  except Exception as e:
      st.error('UI render failed'); st.exception(e); st.stop()
  ```
- **Compatibility shims:** If public APIs move (e.g., `write_provenance` migrated to `app.server.provenance`), add a shim in the old module path rather than refactoring callers mid‑patch.
- **Guarded imports:** Never let an import error blank the page; catch, render `st.error`, and stop.

---

## 6. Streamlit‑Specific Hardening

- **Interaction guards:**
  - Example toggles → route through `safe_ingest(func, ...)` that catches exceptions and renders them.
  - Docs reader → `safe_read_text(path)` tries utf‑8 then latin‑1; render a helpful warning on `FileNotFoundError`.
- **State hygiene:** Do not mutate global state without a session key. Use clear cache invalidation on data reload.
- **UI contract stability:** Tabs and sidebar controls must exist and preserve labels/keys; verifier checks them.

---

## 7. Sidebar & Tabs (Canonical v1.1.3e Contract)

**Sidebar controls:**
- Examples: He / Ne
- Display mode: Overlay | Differential | Docs
- Display units: nm | Å | µm | cm⁻¹
- Duplicate scope: Global | Session only | Off
- Actions: Purge session duplicates, Export what I see

**Tabs:**
- Overlay: uploader, duplicate banner with “Ingest anyway”, plot, provenance/session logs expander.
- Differential: Trace A/B selects, operation (A−B/A÷B), normalization, resample points slider, “Compute differential”, output trace with logs.
- Docs: doc picker, markdown renderer.

Any deviation requires updating the UI verifier and patch notes.

---

## 8. Provenance, Versioning, and Export

- **version.json** drives the in‑app badge and export stamping.
- **Export manifest** must include:
  - App version, timestamp
  - Data sources and fetch provenance
  - Transformations applied (unit conversions, normalization, resampling)
  - UI state (units, display mode)
- **Shims** for provenance writers keep legacy imports alive during refactors.

---

## 9. Common Failure Modes & Fix Patterns

- **Nested folder (spectra-app/spectra-app):** Flatten, move inner contents to root, delete nested.
- **Missing symbol after refactor:** Add compatibility shim in the old module path.
- **Blank screen after clicking UI:** Add safety guards and force UI reload each run.
- **Old version label:** Ensure `version.json` was bumped and the header reads from it, not a hardcoded string.
- **Docs blanking:** Wrap file read/markdown render, show errors rather than re‑raising.
- **Examples crash:** Path mismatch or ingest error; guard and surface tracebacks.

---

## 10. Verification & Rollback

- **Verification:**
  - Project verifier: prints version and acceptance checks.
  - UI contract verifier: asserts presence of sidebar controls/tabs.
- **Rollback:** Keep pre‑patch zip. Replace edited files with `.bak` when needed; restore `version.json` and purge `__pycache__`.

---

## 11. Ready‑To‑Run Commands (Windows)

```powershell
# Verify
C:\Code\spectra-app\RUN_CMDS\Verify-Project.ps1
C:\Code\spectra-app\RUN_CMDS\Verify-UI-Contract.ps1

# Start
C:\Code\spectra-app\RUN_CMDS\Start-Spectra-Patched.ps1
```

---

**Last updated:** 2025-09-20T00:32:10.774665Z
