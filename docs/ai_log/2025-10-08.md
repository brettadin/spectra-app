# AI Log — 2025-10-08

## Tasking — v1.2.0l
- Isolate overlay viewport state per axis kind, warn when mixed time/wavelength traces render together, and keep exports/tests in sync.
- Roll continuity collateral (brains, patch notes, version, AI log) for the new hotfix.

## Actions & Decisions
- Introduced axis-kind helpers and migrated session state to a `viewport_axes` map so wavelength and time traces keep independent zoom ranges. 【F:app/ui/main.py†L336-L407】【F:app/ui/main.py†L421-L472】
- Updated the sidebar and overlay tab to select viewports per axis, emit mixed-axis warnings, and pass axis-aware ranges into plot construction. 【F:app/ui/main.py†L1034-L1114】【F:app/ui/main.py†L2411-L2467】
- Reworked `_build_overlay_figure` and export helpers to honor axis-specific viewports, surface "Mixed axes" titles, and include axis metadata in exported rows. 【F:app/ui/main.py†L1608-L1756】【F:app/ui/main.py†L2086-L2154】
- Extended UI regression coverage for time-series mixes and added a mixed-axis overlay test. 【F:tests/ui/test_auto_viewport.py†L34-L71】【F:tests/ui/test_overlay_mixed_axes.py†L1-L40】
- Logged the design rationale in the atlas brain dump and refreshed versioned continuity docs (brains log/index + patch notes). 【F:docs/atlas/brains.md†L1-L4】【F:docs/brains/brains_v1.2.0l.md†L1-L23】【F:docs/brains/brains_INDEX.md†L1-L18】【F:docs/patch_notes/v1.2.0l.md†L1-L23】

## Verification
- `pytest tests/ui/test_auto_viewport.py tests/ui/test_overlay_full_resolution.py tests/ui/test_overlay_hover.py tests/ui/test_overlay_mixed_axes.py` 【c01f00†L1-L8】

## Outstanding Follow-ups
- Consider adding an explicit axis selector in the sidebar if future payloads introduce additional axis kinds beyond wavelength/time.
- Monitor downstream consumers for the new `axis_kind`/`unit` export fields and update docs if schema consumers request clarifications.

## Docs Consulted
- Astropy time-series overview for axis handling expectations. 【F:docs/mirrored/astropy/timeseries.meta.json†L1-L7】

## Tasking — v1.2.0m
- Relocate the overlay clearing affordance into the Display & viewport controls and confirm the action inside the overlay workspace.

## Actions & Decisions
- Moved the "Clear overlays" button into the sidebar display section, disabled it when no overlays are loaded, and set a session flag so the action still calls `_clear_overlays()`. 【F:app/ui/main.py†L1034-L1045】
- Added an overlay-tab warning banner that consumes the session flag to acknowledge the removal in context while leaving the differential reference chooser untouched. 【F:app/ui/main.py†L2399-L2408】【F:app/ui/main.py†L2375-L2396】
- Extended UI tests to assert the control’s relocation and absence from the differential tab. 【F:tests/ui/test_differential_form.py†L66-L80】【F:tests/ui/test_sidebar_display_controls.py†L1-L35】

## Verification
- `pytest tests/ui/test_differential_form.py tests/ui/test_sidebar_display_controls.py` 【97f227†L1-L6】

## Docs Consulted (v1.2.0m)
- JWST portal overlay UX reference for contextual confirmation guidance. 【F:docs/mirrored/jwst_docs/accessing-jwst-data.meta.json†L1-L5】

## Tasking — v1.2.0n
- Accept 2-D FITS images as overlays, preserve spatial WCS metadata, surface a viewer with contrast control, and roll continuity updates.

## Actions & Decisions
- Extended `_ingest_image_hdu` with WCS-based axis detection, serialised image payloads/masks, and `axis_kind="image"` metadata while keeping spectral collapse for genuine wavelength axes. 【F:app/server/ingest_fits.py†L1120-L1350】
- Updated `ingest_local_file` summaries and safeguards so spatial images bypass spectral sample checks yet propagate pixel counts and `image` payloads. 【F:app/utils/local_ingest.py†L433-L517】
- Added image-aware overlay handling—new heatmap panels with intensity sliders, metadata formatting, and mixed-axis filtering across the UI. 【F:app/ui/main.py†L60-L206】【F:app/ui/main.py†L1910-L2079】
- Augmented regression coverage for spatial ingestion, local upload, and UI rendering; refreshed contract, version, brains, and patch notes accordingly. 【F:tests/server/test_ingest_fits.py†L214-L260】【F:docs/patch_notes/v1.2.0n.md†L1-L25】

## Verification
- `pytest tests/server/test_ingest_fits.py tests/server/test_local_ingest.py` 【f66e47†L1-L33】
- `pytest tests/ui/test_metadata_summary.py tests/ui/test_overlay_mixed_axes.py tests/ui/test_overlay_additional_traces.py` 【bd7771†L1-L18】

## Docs Consulted (v1.2.0n)
- Astropy WCS overview for axis typing guidance. 【F:docs/mirrored/astropy/wcs.meta.json†L1-L6】
