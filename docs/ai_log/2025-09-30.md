# AI Log — 2025-09-30

## Tasking
- Address crash in FITS table ingestion when provenance attempted to reference an undefined non-positive row counter.
- Recreate missing runtime inventory documentation and roll continuity artifacts for the v1.2.0 handoff.

## Actions & Decisions
- Verified environment package versions via `importlib.metadata` because `docs/runtime.json` was absent; recorded the snapshot (REF 1.2.0-C01).
- Inspected `_extract_table_data` in `app/server/ingest_fits.py` and refactored the non-positive filtering logic to define a consolidated `dropped_nonpositive_rows` counter, eliminating the undefined variable reference (REF 1.2.0-A01).
- Added regression coverage in `tests/server/test_ingest_fits.py` to ingest a wavenumber column containing zero/negative values and assert the provenance fields.
- Attempted to query `tools/search_server.py` per protocol, but the script is missing in this repository snapshot; noted for future restoration.
- Updated `app/version.json`, patch notes, brains, AI handoff prompt, and patch log to introduce v1.2.0 continuity entries.

## Outstanding Follow-ups
- Rebuild the documentation mirror tooling referenced in historical instructions so `docs/sources.yaml` and related indices can be regenerated once restored.
- Execute `Verify-Project.ps1` in a Windows environment and confirm ingestion roadmap tasks (SIMBAD resolver, archive consolidation, provenance enrichment) progress in subsequent patches.

---

## Tasking — v1.2.0a
- Normalise FITS ingestion so plural/aliased Angstrom labels succeed.
- Extend regression coverage and roll continuity collateral for the hotfix.

## Actions & Decisions
- Added alias-aware handling in `app/server/ingest_fits.py` and `app/server/units.py` so `canonical_unit` accepts plural Angstrom spellings.
- Backfilled regression coverage for the "Angstroms" scenario and updated patch notes, brains, AI handoff, and patch log for v1.2.0a.
- Attempted to start the documentation search server, but it still requires the unavailable `faiss` dependency. 【db955f†L1-L5】

## Verification
- `pytest tests/server/test_ingest_fits.py -k Angstroms`. 【3d3cce†L1-L16】
- Manual `parse_fits` run against an "Angstroms" FITS table confirming canonical labelling and nm conversion. 【6e7934†L1-L5】

## Outstanding Follow-ups
- Restore the FAISS-backed documentation search stack or replace it so docs-first queries succeed.
- Continue the v1.2 roadmap items (SIMBAD resolver, ingestion consolidation, provenance enrichment, caching) once the tooling gap is resolved.

## Tasking — v1.2.0b
- Allow FITS time-series tables into the ingestion pipeline without tripping spectral-only guards.
- Update the Streamlit overlay UI so time axes display their native units/ranges.
- Refresh continuity collateral (version, brains, patch notes, AI handoff, AI log) for the v1.2.0b handoff.

## Actions & Decisions
- Extended `app/server/ingest_fits.py` to classify TIME columns via label/unit heuristics, emit `axis_kind="time"`, and include `time_range`/`time_unit` metadata plus provenance (`time_converted_to`, `time_original_unit`).
- Propagated the new axis metadata through `_ingest_table_hdu`, `parse_fits`, and the overlay UI so plots label `Time (...)`, metadata tables use an "Axis range" column, and regression helpers understand `axis_kind`.
- Added time-series regression coverage and refreshed docs (`docs/brains/brains_v1.2.0b.md`, `docs/patch_notes/v1.2.0b.md`, `docs/ai_handoff/AI_HANDOFF_PROMPT_v1.2.0b.md`, `PATCHLOG.txt`, `app/version.json`).

## Verification
- `pytest tests/server/test_ingest_fits.py::test_parse_fits_accepts_time_series_units` 【a5cbed†L1-L9】
- `pytest tests/ui/test_metadata_summary.py` 【04e646†L1-L14】

## Outstanding Follow-ups
- Mirror the time-axis detection in ASCII ingestion so CSV light curves get the same metadata treatment.
- Evaluate support for image HDUs with temporal WCS metadata and decide whether to reuse the time-series pathway.
- Continue the v1.2 roadmap (SIMBAD resolver, ingestion consolidation, provenance enrichment, caching) once the time-series flow stabilises.

### Citations
- https://mast.stsci.edu/api/v0/md_result_formats.html


### Citations
- docs/mirrored/astropy/coordinates.meta.json

---

## Tasking — v1.2.0c
- Stop the example browser from overwriting provider filters on rerun.
- Eliminate the Streamlit widget warning triggered by reassigning `example_browser_provider_filter` defaults.
- Refresh documentation (UI review, patch notes, AI log) and record manual verification.

## Actions & Decisions
- Reordered session-state initialisation in `app/ui/example_browser.py` so provider selections are seeded before rendering the multiselect and sanitised only when provider options change. 【F:app/ui/example_browser.py†L119-L139】
- Dropped the `default=` argument once session state exists, letting Streamlit reuse persisted selections and preventing the duplicate-key warning. 【F:app/ui/example_browser.py†L141-L144】
- Updated `docs/library_usage_review.md` with a note about the persistent provider filters and rolled fresh patch notes plus patch log continuity for v1.2.0c. 【F:docs/library_usage_review.md†L31-L33】【F:docs/patch_notes/v1.2.0c.md†L1-L25】【F:PATCHLOG.txt†L17-L18】
- Attempted to query the local docs search service, but it remains unavailable in this snapshot; noted for future restoration.

## Verification
- Manual QA: `PYTHONPATH=/workspace/spectra-app streamlit run app/ui/main.py --server.headless true --server.port 8501 --server.address 0.0.0.0 --browser.gatherUsageStats false` (provider filters persist, no widget warning). 【67e5e1†L1-L2】【8c1277†L1-L5】
- Playwright session confirming only ESO/MAST remain selected after filtering. 【grdnbrgb†L1-L1】

## Outstanding Follow-ups
- Restore the docs search server tooling so protocol-mandated queries can succeed instead of being noted as unavailable.
- Consider porting the provider-filter persistence fix into automated UI tests to guard against regressions.

